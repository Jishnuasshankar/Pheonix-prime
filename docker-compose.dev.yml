# ==============================================================================
# MasterX - Development Environment (Docker Compose)
# ==============================================================================
# Development setup with hot reload, debugging, and volume mounts
# Following Big Tech standards for local development
# ==============================================================================

version: '3.9'

services:
  # ============================================================================
  # MongoDB Database
  # ============================================================================
  mongodb:
    image: mongo:7.0
    container_name: masterx-mongodb-dev
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-masterx_dev_password}
      MONGO_INITDB_DATABASE: ${DB_NAME:-masterx}
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - masterx-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    command: mongod --bind_ip_all

  # ============================================================================
  # Backend API (Development with hot reload)
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: masterx-backend-dev
    restart: unless-stopped
    ports:
      - "8001:8001"
    
    # FIX 1: Load the bulk of variables from the file so you don't have to list them all
    # This solves your "unable to read backend/.env" issue.
    env_file:
      - ./backend/.env

    # FIX 2: Override ONLY the database URL to point to the docker service
    # 'environment' takes precedence over 'env_file'.
    environment:
      # This fixes the [Errno 111] Connection Refused
      - MONGO_URL=mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-masterx_dev_password}@mongodb:27017
      - DB_NAME=${DB_NAME:-masterx}
      # Force Python to flush logs immediately
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1


    volumes:
      # FIX 3: Remove ':ro' (Read-Only) to fix the "mkdir" crash
      - ./backend:/app
      
      # FIX 4: Correct the cache path to match the non-root user (masterx)
      - ml_models_cache:/home/masterx/.cache
      
      # Logs volume
      - backend_logs:/app/logs

    networks:
      - masterx-network
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s 
    command: uvicorn server:app --host 0.0.0.0 --port 8001 --reload --log-level debug

  # ============================================================================
  # Frontend (Development with hot reload)
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: masterx-frontend-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - VITE_BACKEND_URL=http://localhost:8001
      - VITE_WS_URL=ws://localhost:8001
      # Force polling so file changes are detected on Mac/Windows
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
      - NODE_ENV=development
    volumes:
      # Remove :ro so Vite can write temporary cache files if needed
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      # Keep node_modules isolated
      - /app/node_modules
    networks:
      - masterx-network
    depends_on:
      - backend
    # FIX: Use curl instead of wget, or a simple TCP check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"] 
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

# ==============================================================================
# Networks
# ==============================================================================
networks:
  masterx-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  ml_models_cache:
    driver: local
  backend_logs:
    driver: local
