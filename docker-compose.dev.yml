# ==============================================================================
# MasterX - Development Environment (Docker Compose)
# ==============================================================================
# Development setup with hot reload, debugging, and volume mounts
# Following Big Tech standards for local development
# ==============================================================================

version: '3.9'

services:
  # ============================================================================
  # MongoDB Database
  # ============================================================================
  mongodb:
    image: mongo:7.0
    container_name: masterx-mongodb-dev
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-masterx_dev_password}
      MONGO_INITDB_DATABASE: ${DB_NAME:-masterx}
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - masterx-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    command: mongod --bind_ip_all

  # ============================================================================
  # Backend API (Development with hot reload)
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: masterx-backend-dev
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      # Database
      MONGO_URL: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-masterx_dev_password}@mongodb:27017
      DB_NAME: ${DB_NAME:-masterx}
      
      # CORS (allow development ports)
      CORS_ORIGINS: http://localhost:3000,http://localhost:5173,http://127.0.0.1:3000
      
      # AI Provider Keys (from host .env)
      GROQ_API_KEY: ${GROQ_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY}
      ARTIFICIAL_ANALYSIS_API_KEY: ${ARTIFICIAL_ANALYSIS_API_KEY}
      SERPER_API_KEY: ${SERPER_API_KEY}
      
      # Models
      GROQ_MODEL_NAME: ${GROQ_MODEL_NAME:-llama-3.3-70b-versatile}
      GEMINI_MODEL_NAME: ${GEMINI_MODEL_NAME:-gemini-2.5-flash}
      WHISPER_MODEL_NAME: ${WHISPER_MODEL_NAME:-whisper-large-v3-turbo}
      ELEVENLABS_MODEL_NAME: ${ELEVENLABS_MODEL_NAME:-eleven_flash_v2_5,eleven_multilingual_v2}
      
      # Security
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev_secret_key_change_in_production}
      ENABLE_HSTS: "false"
      
      # Rate Limiting (relaxed for development)
      SECURITY_RATE_LIMIT_IP_PER_MINUTE: 120
      SECURITY_RATE_LIMIT_USER_PER_MINUTE: 60
      SECURITY_RATE_LIMIT_CHAT_PER_MINUTE: 30
      
      # Development settings
      LOG_LEVEL: DEBUG
      ENVIRONMENT: development
      PYTHONUNBUFFERED: "1"
    volumes:
      # Mount code for hot reload (read-only for safety)
      - ./backend:/app:ro
      # Separate writable volumes for cache and logs
      - ml_models_cache:/root/.cache
      - backend_logs:/app/logs
    networks:
      - masterx-network
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # ML models need time to load
    command: uvicorn server:app --host 0.0.0.0 --port 8001 --reload --log-level debug

  # ============================================================================
  # Frontend (Development with hot reload)
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: masterx-frontend-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # Backend API URL (points to backend container)
      VITE_BACKEND_URL: http://localhost:8001
      VITE_WS_URL: ws://localhost:8001
      
      # Feature flags
      VITE_ENABLE_VOICE: "true"
      VITE_ENABLE_ANALYTICS: "true"
      VITE_ENABLE_GAMIFICATION: "true"
      
      # App config
      VITE_APP_NAME: MasterX
      VITE_APP_VERSION: 1.0.0
      VITE_ENVIRONMENT: development
      
      # Development settings
      NODE_ENV: development
      CHOKIDAR_USEPOLLING: "true"
    volumes:
      # Mount source code for hot reload (read-only)
      - ./frontend/src:/app/src:ro
      - ./frontend/public:/app/public:ro
      # Anonymous volume for node_modules (don't mount from host)
      - /app/node_modules
    networks:
      - masterx-network
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

# ==============================================================================
# Networks
# ==============================================================================
networks:
  masterx-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  ml_models_cache:
    driver: local
  backend_logs:
    driver: local
