# ==============================================================================
# MasterX - Production Environment (Docker Compose)
# ==============================================================================
# Production setup with optimizations, resource limits, and replicas
# Following Big Tech standards for production deployment
# ==============================================================================

version: '3.9'

services:
  # ============================================================================
  # MongoDB Database (Production with authentication)
  # ============================================================================
  mongodb:
    image: mongo:7.0
    container_name: masterx-mongodb-prod
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${DB_NAME}
    volumes:
      - mongodb_data_prod:/data/db
      - mongodb_config_prod:/data/configdb
      - ./mongodb-logs:/var/log/mongodb
    networks:
      - masterx-network-prod
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    command: mongod --bind_ip_all --logpath /var/log/mongodb/mongod.log

  # ============================================================================
  # Backend API (Production optimized)
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: masterx-backend-prod
    restart: always
    environment:
      # Database
      MONGO_URL: mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongodb:27017
      DB_NAME: ${DB_NAME}
      
      # CORS (production domains only)
      CORS_ORIGINS: ${PROD_CORS_ORIGINS}
      
      # AI Provider Keys
      GROQ_API_KEY: ${GROQ_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY}
      ARTIFICIAL_ANALYSIS_API_KEY: ${ARTIFICIAL_ANALYSIS_API_KEY}
      SERPER_API_KEY: ${SERPER_API_KEY}
      
      # Models
      GROQ_MODEL_NAME: ${GROQ_MODEL_NAME}
      GEMINI_MODEL_NAME: ${GEMINI_MODEL_NAME}
      WHISPER_MODEL_NAME: ${WHISPER_MODEL_NAME}
      ELEVENLABS_MODEL_NAME: ${ELEVENLABS_MODEL_NAME}
      
      # Security
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      ENABLE_HSTS: "true"
      
      # Rate Limiting (production values)
      SECURITY_RATE_LIMIT_IP_PER_MINUTE: ${SECURITY_RATE_LIMIT_IP_PER_MINUTE:-60}
      SECURITY_RATE_LIMIT_USER_PER_MINUTE: ${SECURITY_RATE_LIMIT_USER_PER_MINUTE:-30}
      SECURITY_RATE_LIMIT_CHAT_PER_MINUTE: ${SECURITY_RATE_LIMIT_CHAT_PER_MINUTE:-10}
      
      # Production settings
      LOG_LEVEL: INFO
      ENVIRONMENT: production
      PYTHONUNBUFFERED: "1"
      WORKERS: "4"
    volumes:
      # Cache ML models (persistent)
      - ml_models_cache_prod:/root/.cache
      # Logs (persistent)
      - ./logs/backend:/app/logs
    networks:
      - masterx-network-prod
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    command: uvicorn server:app --host 0.0.0.0 --port 8001 --workers 4

  # ============================================================================
  # Frontend (Production build served by Nginx)
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: masterx-frontend-prod
    restart: always
    networks:
      - masterx-network-prod
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # ============================================================================
  # Nginx Reverse Proxy (Load Balancer & SSL Termination)
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: masterx-nginx-prod
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx
    networks:
      - masterx-network-prod
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

# ==============================================================================
# Networks
# ==============================================================================
networks:
  masterx-network-prod:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  mongodb_data_prod:
    driver: local
  mongodb_config_prod:
    driver: local
  ml_models_cache_prod:
    driver: local
